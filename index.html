<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FunkPhonic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#7A1FA2"/>
  <style>
    :root{ --bg:#151515; --fg:#fff; --purple:#7A1FA2; --heli:#DF5086; --teal:#24B3A8; --orange:#FF7227; }
    body{ background:var(--bg); color:var(--fg); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:100%; max-width:820px; background:#1a1a1a; border:1px solid var(--teal); border-radius:20px; box-shadow:0 0 24px rgba(36,179,168,.25); padding:28px; display:flex; flex-direction:column; gap:18px; }
    textarea,input[type="text"]{ background:#242424; color:#fff; border:2px solid var(--purple); border-radius:12px; padding:12px; outline:none; }
    input[type="file"]{ color:#ddd; }
    button{ background:var(--purple); color:#fff; border:none; border-radius:12px; padding:12px 16px; font-weight:700; box-shadow:0 0 10px rgba(122,31,162,.35); transition:.2s; }
    button:hover{ transform:translateY(-2px); }
    .btn-teal{ background:var(--teal); } .btn-orange{ background:var(--orange); }
    .spinner{ border:4px solid rgba(255,255,255,.25); border-left-color:var(--teal); width:20px; height:20px; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; margin-left:8px; visibility:hidden; }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .msg{ display:none; padding:12px 14px; border-radius:12px; text-align:center; font-weight:600; }
    .msg.info{ background:#17324d; color:#cfe9ff; } .msg.error{ background:#4d1717; color:#ffd0d0; } .msg.success{ background:#0f3a33; color:#bff1ea; }
    .hint{ font-size:12px; color:#aaa; }
  </style>
</head>
<body>
  <main class="card">
    <header class="text-center">
      <h1 class="text-4xl font-extrabold" style="color:#DF5086">FunkPhonic</h1>
      <p class="mt-1 text-sm text-gray-300">Write the script ‚Üí Upload voice (once) ‚Üí Generate & Download MP3</p>
    </header>

    <!-- Script -->
    <section>
      <label class="block mb-2 text-sm text-gray-300">Vocal script</label>
      <textarea id="script" placeholder="Type exactly what the voice should say..." rows="8"></textarea>
    </section>

    <!-- Upload/clone (one-time) -->
    <section>
      <label class="block mb-2 text-sm text-gray-300">Upload a voice sample (one-time)</label>
      <div class="flex flex-wrap gap-3 items-center">
        <input id="voice-name" type="text" placeholder="Voice name (e.g., Elitha)" class="flex-1 min-w-[200px]"/>
        <input id="voice-file" type="file" accept="audio/*" class="flex-1 min-w-[200px]"/>
        <button id="upload" class="btn-teal">‚¨ÜÔ∏è Upload & Clone <span id="up-spin" class="spinner"></span></button>
      </div>
      <div id="voice-status" class="hint mt-2">No voice uploaded yet.</div>
    </section>

    <!-- Generate -->
    <section class="flex flex-wrap gap-3 items-center">
      <button id="generate" class="btn-orange">üéß Generate MP3 <span id="gen-spin" class="spinner"></span></button>
      <a id="download" class="hidden px-4 py-3 rounded-xl" style="background:#24B3A8;color:#111;font-weight:800;text-decoration:none" download="funkphonic.mp3">‚¨áÔ∏è Download MP3</a>
      <audio id="player" controls class="flex-1 min-w-[240px]"></audio>
    </section>

    <div id="msg" class="msg info"></div>
    <pre id="err" style="display:none;background:#2a2a2a;color:#ffe;padding:10px;border-radius:10px;font-size:12px;"></pre>
  </main>

  <script>
    // ===== CONFIG: set your backend Worker base URL =====
    const PROXY_BASE = 'https://YOUR-WORKER-NAME.YOURNAME.workers.dev'; // <-- replace with your Worker
    const CLONE_URL = PROXY_BASE + '/clone';
    const TTS_URL   = PROXY_BASE + '/tts';

    // ===== Elements =====
    const $ = id => document.getElementById(id);
    const scriptEl = $('script');
    const voiceName = $('voice-name');
    const voiceFile = $('voice-file');
    const uploadBtn = $('upload');
    const upSpin = $('up-spin');
    const voiceStatus = $('voice-status');
    const genBtn = $('generate');
    const genSpin = $('gen-spin');
    const downloadA = $('download');
    const player = $('player');
    const msg = $('msg');
    const err = $('err');

    // ===== Helpers =====
    const busy = (btn, spin, on=true) => { if(btn) btn.disabled=on; if(spin) spin.style.visibility = on ? 'visible':'hidden'; }
    const showMsg = (text,type='info',ms=3500)=>{ msg.className='msg '+type; msg.textContent=text; msg.style.display='block'; if(ms) setTimeout(()=>msg.style.display='none',ms); }
    const showErr = (e)=>{ err.style.display='block'; err.textContent = typeof e==='string'?e:(e?.message||JSON.stringify(e)); }
    const clearErr= ()=>{ err.style.display='none'; err.textContent=''; }
    const setVoiceId = id => localStorage.setItem('eleven_voice_id', id||'');
    const getVoiceId = () => localStorage.getItem('eleven_voice_id') || '';

    const refreshVoiceStatus = ()=>{
      const id = getVoiceId();
      voiceStatus.textContent = id ? `Voice ready (id: ${id.slice(0,8)}‚Ä¶)` : 'No voice uploaded yet.';
    };
    refreshVoiceStatus();

    // ===== Upload & Clone =====
    uploadBtn.addEventListener('click', async ()=>{
      const name = (voiceName.value||'').trim();
      const file = voiceFile.files && voiceFile.files[0];
      if(!name){ showMsg('Name your voice.', 'error'); return; }
      if(!file){ showMsg('Choose an audio file.', 'error'); return; }

      busy(uploadBtn, upSpin, true); clearErr();
      try{
        const fd = new FormData();
        fd.append('name', name);
        fd.append('file', file, file.name);
        const res = await fetch(CLONE_URL, { method:'POST', body: fd });
        const txt = await res.text();
        if(!res.ok) throw new Error(txt || `Clone failed (${res.status})`);
        let data={}; try{ data=JSON.parse(txt);}catch{}
        const vid = (data.voice_id || data?.voice?.voice_id || '').toString();
        if(!vid) throw new Error('Clone succeeded but no voice_id returned.');
        setVoiceId(vid);
        refreshVoiceStatus();
        showMsg('‚úÖ Voice cloned and stored.', 'success');
      }catch(e){ showMsg('Upload failed. See details below.', 'error', 7000); showErr(e); }
      finally{ busy(uploadBtn, upSpin, false); }
    });

    // ===== Generate MP3 =====
    genBtn.addEventListener('click', async ()=>{
      const text = scriptEl.value.trim();
      if(!text){ showMsg('Type your vocal script first.', 'error'); return; }
      busy(genBtn, genSpin, true); clearErr(); downloadA.classList.add('hidden'); player.removeAttribute('src');

      try{
        const body = { text };
        const vid = getVoiceId();
        if (vid) body.voice_id = vid; // else backend must have ELEVEN_VOICE_ID

        const res = await fetch(TTS_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(t || `TTS failed (${res.status})`);
        }
        const buf = await res.arrayBuffer();
        const blob = new Blob([buf], { type:'audio/mpeg' });
        const url  = URL.createObjectURL(blob);

        player.src = url;
        try{ await player.play(); }catch{}
        downloadA.href = url;
        downloadA.classList.remove('hidden');
        showMsg('üéß MP3 ready ‚Äî download below.', 'success');
      }catch(e){ showMsg('Generation error. See details below.', 'error', 7000); showErr(e); }
      finally{ busy(genBtn, genSpin, false); }
    });

    // ===== (Optional) register your PWA SW if you still use frontend worker.js =====
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> {
        navigator.serviceWorker.register('./worker.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
