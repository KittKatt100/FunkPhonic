<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FunkPhonic</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7A1FA2" />

  <style>
    :root{
      --bg:#151515; --fg:#ffffff;
      --purple:#7A1FA2; --orange:#FF7227;
      --heli:#DF5086; --teal:#24B3A8;
    }
    body{
      background:var(--bg); color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:100%; max-width:720px; background:#1a1a1a; border:1px solid var(--teal);
      border-radius:20px; box-shadow:0 0 24px rgba(122,31,162,.35);
      padding:28px; display:flex; flex-direction:column; gap:18px;
    }
    textarea{
      background:#242424; color:#fff; border:2px solid var(--purple); border-radius:12px;
      padding:14px; min-height:140px; resize:vertical; outline:none;
    }
    select, button{
      background:var(--purple); color:#fff; border:none; border-radius:12px; padding:12px 16px;
    }
    button{ font-weight:700; box-shadow:0 0 10px rgba(122,31,162,.4); transition:.2s transform,.2s background; }
    button:hover{ transform:translateY(-2px); }
    .btn-orange{ background:var(--orange); }
    .btn-orange:hover{ background:#e25f17; }
    .btn-purple{ background:var(--purple); }
    .btn-purple:hover{ background:#6b1593; }
    .btn-teal{ background:var(--teal); }
    .btn-teal:hover{ background:#1ea197; }
    .chip{ background:#242424; border:1px solid #333; border-radius:999px; padding:6px 10px; font-size:12px; color:#aaa; }
    .spinner{
      border:4px solid rgba(255,255,255,.25); border-left-color:var(--teal); width:22px;height:22px;border-radius:50%;
      animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px; visibility:hidden;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .msg{ display:none; padding:12px 14px; border-radius:12px; text-align:center; font-weight:600; }
    .msg.info{ background:#17324d; color:#cfe9ff; }
    .msg.error{ background:#4d1717; color:#ffd0d0; }
    .msg.success{ background:#0f3a33; color:#bff1ea; }
    .link-ghost{ color:var(--teal); text-decoration:none; font-weight:700; display:none; text-align:center; }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .row > *{ flex:1 1 auto; }
    .row .tight{ flex:0 0 auto; }
  </style>
</head>
<body>
  <main class="card">
    <header class="text-center">
      <h1 class="text-4xl font-extrabold text-[#DF5086]">FunkPhonic</h1>
      <p class="mt-1 text-sm text-gray-300">Type a script â†’ choose engine â†’ make it talk â†’ <span class="text-[#24B3A8]">download MP3 (with ElevenLabs)</span></p>
    </header>

    <!-- Script input -->
    <section>
      <label class="block mb-2 text-sm text-gray-300">Describe the script you want</label>
      <textarea id="text-input" placeholder="e.g., Write a 20-second hype ad for Funkultureâ€™s Heliconia candles with a confident, playful tone."></textarea>
    </section>

    <!-- Controls row: engine + voice + settings -->
    <section class="row">
      <div>
        <label class="block mb-2 text-sm text-gray-300">Voice Engine</label>
        <select id="engine-select" class="w-full">
          <option value="browser">Browser (device voices)</option>
          <option value="elevenlabs">ElevenLabs (API)</option>
        </select>
      </div>
      <div id="browser-voice-wrap">
        <label class="block mb-2 text-sm text-gray-300">Select Voice (Browser)</label>
        <select id="voice-select" class="w-full"></select>
      </div>
      <div class="tight">
        <button id="settings-btn" class="btn-teal">âš™ï¸ Settings</button>
      </div>
    </section>

    <!-- Action buttons -->
    <section class="row">
      <button id="generate-btn" class="btn-orange">âœ¨ Generate Script <span id="gen-spinner" class="spinner"></span></button>
      <button id="speak-btn" class="btn-purple">ğŸ—£ï¸ Speak It</button>
      <button id="stop-btn" class="btn-purple">â›” Stop</button>
      <button id="voicegen-btn" class="btn-teal">ğŸ§ Generate Voice <span id="tts-spinner" class="spinner"></span></button>
      <a id="download-link" class="link-ghost" href="#" download="funkphonic-voice.mp3">â¬‡ï¸ Download Audio</a>
    </section>

    <!-- Messages -->
    <div id="msg" class="msg info"></div>

    <!-- Tiny help -->
    <div class="row">
      <div class="chip">Tip: â€œGenerate Scriptâ€ writes copy (demo). â€œSpeak Itâ€ = device voice. â€œGenerate Voiceâ€ = ElevenLabs + download.</div>
    </div>
  </main>

  <script>
    // Elements
    const textInput = document.getElementById('text-input');
    const engineSelect = document.getElementById('engine-select');
    const voiceSelect = document.getElementById('voice-select');
    const browserVoiceWrap = document.getElementById('browser-voice-wrap');

    const generateBtn = document.getElementById('generate-btn');
    const speakBtn = document.getElementById('speak-btn');
    const stopBtn = document.getElementById('stop-btn');
    const voiceGenBtn = document.getElementById('voicegen-btn');

    const genSpinner = document.getElementById('gen-spinner');
    const ttsSpinner = document.getElementById('tts-spinner');
    const downloadLink = document.getElementById('download-link');
    const settingsBtn = document.getElementById('settings-btn');
    const msg = document.getElementById('msg');

    // Audio + voices
    const synth = window.speechSynthesis;
    const audioPlayer = new Audio();
    let voices = [];
    let audioBlob = null;

    // Messages
    function showMsg(text, type='info', timeout=4500){
      msg.className = 'msg ' + type;
      msg.textContent = text;
      msg.style.display = 'block';
      if (timeout){ setTimeout(()=> msg.style.display='none', timeout); }
    }
    function setBusy(el, spinning=true){
      if (el === generateBtn) genSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el === voiceGenBtn) ttsSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el) el.disabled = spinning;
      // keep UI sane during API work
      speakBtn.disabled = spinning && el===voiceGenBtn;
      stopBtn.disabled  = spinning && el===voiceGenBtn;
    }

    // Populate browser voices
    function populateVoices(){
      voices = synth.getVoices().filter(v => v && v.name && v.lang);
      voiceSelect.innerHTML = '';
      if (!voices.length){
        const opt = document.createElement('option');
        opt.textContent = 'No voices available (refresh browser)';
        voiceSelect.appendChild(opt);
        return;
      }
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})${v.default ? ' â€¢ default' : ''}`;
        voiceSelect.appendChild(opt);
      });
      const preferred = voices.find(v => v.name.includes('Google')) || voices.find(v => v.lang.startsWith('en')) || voices[0];
      if (preferred) voiceSelect.value = preferred.name;
      showMsg(`ğŸ§ Loaded ${voices.length} device voices`, 'info', 2500);
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoices;
    window.addEventListener('load', populateVoices);

    // Demo "Generate Script" (stub)
    generateBtn.addEventListener('click', ()=>{
      const prompt = textInput.value.trim();
      if (!prompt){ showMsg('Type what kind of script you want first.', 'error'); return; }
      setBusy(generateBtn, true);
      setTimeout(()=>{
        textInput.value = `${prompt}\n\n[FunkPhonic draft]\nIntro fast â€¢ One benefit per line â€¢ Punchy CTA at the end.`;
        setBusy(generateBtn, false);
        showMsg('âœ¨ Script generated (demo).', 'success');
      }, 1100);
    });

    // Speak via browser voices (no download)
    function speakBrowser(text){
      if (!text){ showMsg('Nothing to speak. Type or generate a script.', 'error'); return; }
      if (synth.speaking) synth.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const selected = voices.find(v => v.name === voiceSelect.value);
      if (selected) u.voice = selected;
      u.onend = ()=> showMsg('âœ… Done speaking.', 'success');
      u.onerror = e => showMsg('Speech error: ' + (e.error||'unknown'), 'error');
      synth.speak(u);
      downloadLink.style.display = 'none';
    }
    speakBtn.addEventListener('click', ()=>{
      if (engineSelect.value === 'elevenlabs'){
        showMsg('Use â€œğŸ§ Generate Voiceâ€ for downloadable audio via ElevenLabs.', 'info');
        return;
      }
      speakBrowser(textInput.value.trim());
    });
    stopBtn.addEventListener('click', ()=>{
      if (synth.speaking) synth.cancel();
      audioPlayer.pause(); audioPlayer.currentTime = 0;
      showMsg('â›” Stopped.', 'info', 2000);
    });

    // ElevenLabs settings in localStorage
    function getEleven(){
      return {
        key: localStorage.getItem('eleven_api_key') || '',
        voice: localStorage.getItem('eleven_voice_id') || ''
      };
    }
    function setEleven(key, voice){
      localStorage.setItem('eleven_api_key', key || '');
      localStorage.setItem('eleven_voice_id', voice || '');
    }
    settingsBtn.addEventListener('click', ()=>{
      const cur = getEleven();
      const apiKey = prompt('Enter ElevenLabs API Key (stored only in this browser):', cur.key || '');
      if (apiKey === null) return;
      const voiceId = prompt('Enter ElevenLabs Voice ID:', cur.voice || '');
      if (voiceId === null) return;
      setEleven(apiKey.trim(), voiceId.trim());
      showMsg('Saved ElevenLabs settings locally.', 'success');
    });

    // ElevenLabs TTS (downloadable MP3)
    async function ttsElevenLabs(text){
      const { key, voice } = getEleven();
      if (!key || !voice){
        showMsg('Set your ElevenLabs API Key & Voice ID (âš™ï¸ Settings).', 'error');
        return;
      }
      setBusy(voiceGenBtn, true);
      downloadLink.style.display = 'none';
      try{
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}`, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'xi-api-key': key
          },
          body: JSON.stringify({
            text,
            model_id: 'eleven_monolingual_v1',
            voice_settings: { stability: 0.5, similarity_boost: 0.75 }
          })
        });
        if (!res.ok){ throw new Error('TTS failed: ' + res.status); }
        const buf = await res.arrayBuffer();
        audioBlob = new Blob([buf], { type:'audio/mpeg' });
        const url = URL.createObjectURL(audioBlob);
        audioPlayer.src = url;
        await audioPlayer.play();
        downloadLink.href = url;
        downloadLink.style.display = 'block';
        showMsg('ğŸ§ Voice ready. You can download the MP3.', 'success');
      }catch(err){
        console.error(err);
        showMsg('ElevenLabs error. Check settings/credits and try again.', 'error');
      }finally{
        setBusy(voiceGenBtn, false);
      }
    }

    voiceGenBtn.addEventListener('click', ()=>{
      const text = textInput.value.trim();
      if (!text){ showMsg('Type or generate a script first.', 'error'); return; }
      if (engineSelect.value === 'browser'){
        showMsg('Switch engine to â€œElevenLabsâ€ for downloadable audio.', 'info');
        speakBrowser(text);
        return;
      }
      ttsElevenLabs(text);
    });

    // Engine toggle
    engineSelect.addEventListener('change', ()=>{
      browserVoiceWrap.style.display = (engineSelect.value === 'browser') ? 'block' : 'none';
      if (engineSelect.value !== 'browser'){
        downloadLink.style.display = 'none';
      }
    });
    browserVoiceWrap.style.display = 'block';
  </script>

  <!-- Register service worker -->
  <script>
    if ('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.log('SW reg failed:', err));
      });
    }
  </script>
</body>
</html>
