<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FunkPhonic</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#7A1FA2"/>

  <style>
    :root{
      --bg:#151515; --fg:#ffffff;
      --purple:#7A1FA2; --orange:#FF7227;
      --heli:#DF5086; --teal:#24B3A8;
    }
    body{
      background:var(--bg); color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:100%; max-width:760px; background:#1a1a1a; border:1px solid var(--teal);
      border-radius:20px; box-shadow:0 0 24px rgba(36,179,168,.25);
      padding:28px; display:flex; flex-direction:column; gap:18px;
    }
    textarea{
      background:#242424; color:#fff; border:2px solid var(--purple); border-radius:12px;
      padding:14px; min-height:140px; resize:vertical; outline:none;
    }
    button{
      background:var(--purple); color:#fff; border:none; border-radius:12px; padding:12px 16px;
      font-weight:700; box-shadow:0 0 10px rgba(122,31,162,.4); transition:.2s transform,.2s background;
    }
    button:hover{ transform:translateY(-2px); }
    .btn-orange{ background:var(--orange); } .btn-orange:hover{ background:#e25f17; }
    .btn-purple{ background:var(--purple); } .btn-purple:hover{ background:#6b1593; }
    .btn-teal{ background:var(--teal); } .btn-teal:hover{ background:#1ea197; }
    .spinner{ border:4px solid rgba(255,255,255,.25); border-left-color:var(--teal); width:22px;height:22px;border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-left:8px; visibility:hidden; }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .msg{ display:none; padding:12px 14px; border-radius:12px; text-align:center; font-weight:600; }
    .msg.info{ background:#17324d; color:#cfe9ff; } .msg.error{ background:#4d1717; color:#ffd0d0; } .msg.success{ background:#0f3a33; color:#bff1ea; }
    .link-ghost{ color:var(--teal); text-decoration:none; font-weight:700; display:none; text-align:center; }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .row > *{ flex:1 1 auto; }
    .row .tight{ flex:0 0 auto; }
    .hint{ font-size:12px; color:#aaa; }
    pre#errorDetail { white-space:pre-wrap; background:#2a2a2a; color:#ffe; padding:10px; border-radius:10px; display:none; font-size:12px; }
  </style>
</head>
<body>
  <main class="card">
    <header class="text-center">
      <h1 class="text-4xl font-extrabold text-[#DF5086]">FunkPhonic</h1>
      <p class="mt-1 text-sm text-gray-300">Write your script ‚Üí preview with device voice ‚Üí <span class="text-[#24B3A8]">generate downloadable MP3</span></p>
    </header>

    <section>
      <label class="block mb-2 text-sm text-gray-300">Your script</label>
      <textarea id="text-input" placeholder="e.g., A tight 20-second hype ad for Funkulture‚Äôs Heliconia candles. Confident, playful, with a punchy CTA."></textarea>
    </section>

    <section id="browser-voice-section">
      <label class="block mb-2 text-sm text-gray-300">Device voice (optional preview)</label>
      <div class="row">
        <select id="voice-select" class="w-full"></select>
        <div class="tight"><button id="speak-btn" class="btn-purple">üó£Ô∏è Speak It</button></div>
        <div class="tight"><button id="stop-btn" class="btn-purple">‚õî Stop</button></div>
      </div>
      <div id="no-voices" class="hint" style="display:none;">No device voices found here. That‚Äôs fine ‚Äî you can still generate the MP3 below.</div>
    </section>

    <section class="row">
      <button id="generate-btn" class="btn-orange">‚ú® Generate Script <span id="gen-spinner" class="spinner"></span></button>
      <button id="voicegen-btn" class="btn-teal">üéß Generate Voice (MP3) <span id="tts-spinner" class="spinner"></span></button>
      <a id="download-link" class="link-ghost" href="#" download="funkphonic-voice.mp3">‚¨áÔ∏è Download Audio</a>
    </section>

    <div id="msg" class="msg info"></div>
    <pre id="errorDetail"></pre>

    <div class="hint">No API keys in the browser. MP3 is generated securely via the FunkPhonic backend.</div>
  </main>

  <script>
    // ---------- CONFIG: set your backend Worker URL ----------
    const PROXY_URL = 'https://YOUR-WORKER-NAME.YOURNAME.workers.dev'; // <‚Äî replace me

    // ---------- Elements ----------
    const textInput = document.getElementById('text-input');
    const voiceSelect = document.getElementById('voice-select');
    const browserVoiceSection = document.getElementById('browser-voice-section');
    const noVoices = document.getElementById('no-voices');

    const generateBtn = document.getElementById('generate-btn');
    const speakBtn = document.getElementById('speak-btn');
    const stopBtn = document.getElementById('stop-btn');
    const voiceGenBtn = document.getElementById('voicegen-btn');
    const genSpinner = document.getElementById('gen-spinner');
    const ttsSpinner = document.getElementById('tts-spinner');
    const downloadLink = document.getElementById('download-link');
    const msg = document.getElementById('msg');
    const errorDetail = document.getElementById('errorDetail');

    // ---------- Messaging ----------
    function showMsg(text, type='info', timeout=4500){
      msg.className = 'msg ' + type;
      msg.textContent = text;
      msg.style.display = 'block';
      if (timeout) setTimeout(()=> msg.style.display='none', timeout);
    }
    function showErrorDetail(obj){
      errorDetail.style.display = 'block';
      try { errorDetail.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); }
      catch { errorDetail.textContent = String(obj); }
    }
    function clearErrorDetail(){ errorDetail.style.display='none'; errorDetail.textContent=''; }
    function setBusy(el, spinning=true){
      if (el === generateBtn) genSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el === voiceGenBtn) ttsSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el) el.disabled = spinning;
    }

    // ---------- Browser voices (optional) ----------
    const synth = window.speechSynthesis;
    let voices = [];

    function populateVoices(){
      voices = synth.getVoices().filter(v => v && v.name && v.lang);
      voiceSelect.innerHTML = '';
      if (!voices.length){
        browserVoiceSection.style.opacity = 0.6;
        noVoices.style.display = 'block';
        return;
      }
      noVoices.style.display = 'none';
      browserVoiceSection.style.opacity = 1;
      voices.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})${v.default ? ' ‚Ä¢ default' : ''}`;
        voiceSelect.appendChild(opt);
      });
      const preferred = voices.find(v => v.name.includes('Google')) || voices.find(v => v.lang.startsWith('en')) || voices[0];
      if (preferred) voiceSelect.value = preferred.name;
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoices;
    window.addEventListener('load', populateVoices);

    function speakBrowser(text){
      if (!text){ showMsg('Nothing to speak. Type or generate a script.', 'error'); return; }
      if (synth.speaking) synth.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const selected = voices.find(v => v.name === voiceSelect.value);
      if (selected) u.voice = selected;
      u.onend = ()=> showMsg('‚úÖ Done speaking.', 'success');
      u.onerror = e => showMsg('Speech error: ' + (e.error||'unknown'), 'error');
      synth.speak(u);
      downloadLink.style.display = 'none';
    }

    speakBtn.addEventListener('click', ()=> speakBrowser(textInput.value.trim()));
    stopBtn.addEventListener('click', ()=>{
      if (synth.speaking) synth.cancel();
      showMsg('‚õî Stopped.', 'info', 1800);
    });

    // ---------- Demo Script Gen ----------
    generateBtn.addEventListener('click', ()=>{
      const prompt = textInput.value.trim();
      if (!prompt){ showMsg('Tell me what kind of script you want first.', 'error'); return; }
      setBusy(generateBtn, true);
      clearErrorDetail();
      setTimeout(()=>{
        textInput.value = `${prompt}\n\n[FunkPhonic draft]\n‚Ä¢ Open strong\n‚Ä¢ One benefit per line\n‚Ä¢ Punchy CTA at the end.`;
        setBusy(generateBtn, false);
        showMsg('‚ú® Script generated (demo).', 'success');
      }, 900);
    });

    // ---------- ElevenLabs via Proxy (secure; backend holds the key) ----------
    async function ttsViaProxy(text){
      const res = await fetch(PROXY_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }) // no key, no voice_id ‚Äî backend can use its default
      });
      if (!res.ok){
        const errTxt = await res.text().catch(()=> '');
        throw new Error(`Proxy ${res.status}: ${errTxt}`);
      }
      return await res.arrayBuffer();
    }

    voiceGenBtn.addEventListener('click', async ()=>{
      const text = textInput.value.trim();
      if (!text){ showMsg('Type or generate a script first.', 'error'); return; }

      setBusy(voiceGenBtn, true);
      clearErrorDetail();
      downloadLink.style.display = 'none';

      try{
        const buf = await ttsViaProxy(text);
        const mp3Blob = new Blob([buf], { type:'audio/mpeg' });
        const url = URL.createObjectURL(mp3Blob);

        const audio = new Audio(url);
        await audio.play().catch(()=>{}); // autoplay may be blocked; user can tap play

        downloadLink.href = url;
        downloadLink.style.display = 'block';
        showMsg('üéß Voice ready ‚Äî download below.', 'success');
      }catch(e){
        console.error(e);
        showMsg('TTS error. See details below.', 'error', 7000);
        showErrorDetail(e.message || e);
      }finally{
        setBusy(voiceGenBtn, false);
      }
    });

    // ---------- Register your FRONTEND service worker (worker.js) ----------
    if ('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./worker.js').catch(err => console.log('SW reg failed:', err));
      });
    }
  </script>
</body>
</html>
