<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FunkPhonic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#7A1FA2"/>

  <style>
    :root{
      --bg:#151515; --fg:#ffffff;
      --purple:#7A1FA2; --orange:#FF7227;
      --heli:#DF5086; --teal:#24B3A8;
      --gradA:#fc6767; --gradB:#ec008c;
    }
    body{
      background:var(--bg); color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:28px;
    }
    .card{
      width:100%; max-width:980px;
      background:#1a1a1a; border:1px solid rgba(36,179,168,.6);
      border-radius:22px; padding:28px;
      box-shadow:0 0 34px rgba(122,31,162,.25), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    textarea, select, input[type="text"]{
      background:#242424; color:#fff; border:2px solid var(--purple); border-radius:14px; padding:14px; outline:none;
    }
    textarea{ min-height:140px; resize:vertical; }
    .btn{
      border:none; border-radius:14px; padding:12px 16px; font-weight:800; color:#fff;
      box-shadow:0 0 14px rgba(122,31,162,.35); transition:.2s transform,.2s filter;
    }
    .btn:hover{ transform:translateY(-2px); filter:brightness(1.03); }
    .btn-purple{ background:var(--purple); }
    .btn-orange{ background:var(--orange); color:#111; }
    .btn-teal{ background:var(--teal); color:#111; }
    .pill{ background:#242424; border:1px solid #333; color:#bbb; padding:6px 10px; border-radius:999px; font-size:12px; }
    .accent{
      background:linear-gradient(90deg,var(--gradA),var(--gradB));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .spinner{
      border:4px solid rgba(255,255,255,.25); border-left-color:var(--teal);
      width:20px; height:20px; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; margin-left:8px; visibility:hidden;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .msg{ display:none; padding:12px 14px; border-radius:12px; text-align:center; font-weight:700; }
    .msg.info{ background:#17324d; color:#cfe9ff; } .msg.error{ background:#4d1717; color:#ffd0d0; } .msg.success{ background:#0f3a33; color:#bff1ea; }
    .drop{
      border:2px dashed rgba(122,31,162,.6); border-radius:16px; background:#1f1f1f;
      display:flex; align-items:center; justify-content:center; padding:20px; cursor:pointer;
    }
    .drop.drag{ background:#222; border-color:var(--heli); }
  </style>
</head>

<body>
  <main class="card">
    <header class="text-center mb-2">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">
        <span class="accent">Funk</span><span style="color:#DF5086">Phonic</span>
      </h1>
      <p class="mt-1 text-sm text-gray-300">
        Type a script ‚Üí (optional) upload your voice once ‚Üí <span class="text-[#24B3A8] font-bold">generate & download MP3</span>
      </p>
    </header>

    <!-- Status / messages -->
    <div id="msg" class="msg info"></div>
    <pre id="err" class="mt-2" style="display:none;background:#2a2a2a;color:#ffe;padding:10px;border-radius:10px;font-size:12px;"></pre>

    <!-- Step 1: Script + Mood + Speed -->
    <section class="mt-3">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <h2 class="text-lg font-bold">1) Your Vocal Script</h2>
        <span class="pill">Brand: #151515 ‚Ä¢ #FFFFFF ‚Ä¢ #7A1FA2 ‚Ä¢ #DF5086 ‚Ä¢ #24B3A8</span>
      </div>
      <textarea id="script" placeholder="Type exactly what the voice should say‚Ä¶ Keep it clean, punchy, and you." spellcheck="false"></textarea>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
        <div>
          <label class="block mb-1 text-sm text-gray-300">Mood</label>
          <select id="mood" class="w-full">
            <option value="">Default</option>
            <option value="commercial" selected>Commercial</option>
            <option value="happy">Happy</option>
            <option value="excited">Excited</option>
            <option value="relaxed">Relaxed</option>
            <option value="conversational">Conversational</option>
            <option value="narration">Narration</option>
            <option value="sad">Sad</option>
            <option value="angry">Angry</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block mb-1 text-sm text-gray-300">
            Playback speed <span id="speedLabel" class="text-[#24B3A8] font-bold">1.00√ó</span>
          </label>
          <input id="speed" type="range" min="0.75" max="1.25" step="0.05" value="1.00" class="w-full">
          <p class="text-xs text-gray-400 mt-1">Speed affects playback here. Downloaded MP3 is original speed (we can server-process later).</p>
        </div>
      </div>
    </section>

    <!-- Step 2: Upload & Clone Voice -->
    <section class="mt-6">
      <h2 class="text-lg font-bold mb-2">2) Upload Your Voice (one-time)</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div class="md:col-span-1">
          <label class="block mb-1 text-sm text-gray-300">Voice name</label>
          <input id="voice-name" type="text" placeholder="e.g., Elitha" class="w-full">
        </div>

        <div class="md:col-span-2">
          <label class="block mb-1 text-sm text-gray-300">Voice sample</label>

          <!-- Drag & drop area triggers hidden file input -->
          <div id="drop" class="drop">
            <div class="text-center">
              <div class="font-bold text-sm">Drop audio here, or click to choose</div>
              <div class="text-xs text-gray-400 mt-1">Accepted: WAV, MP3, M4A, AAC, FLAC</div>
            </div>
            <input id="voice-file" type="file" accept="audio/*,.wav,.mp3,.m4a,.aac,.flac" class="hidden">
          </div>

          <div class="flex items-center gap-3 mt-3">
            <button id="upload" class="btn btn-teal">‚¨ÜÔ∏è Upload & Clone <span id="up-spin" class="spinner"></span></button>
            <span id="fileName" class="text-sm text-gray-300">No file selected.</span>
          </div>
          <p id="voice-status" class="text-xs text-gray-400 mt-1">No voice uploaded yet.</p>
        </div>
      </div>
    </section>

    <!-- Step 3: Generate -->
    <section class="mt-6">
      <h2 class="text-lg font-bold mb-2">3) Generate & Download</h2>
      <div class="flex flex-wrap items-center gap-3">
        <button id="generate" class="btn btn-orange">üéß Generate MP3 <span id="gen-spin" class="spinner"></span></button>
        <a id="download" class="btn btn-purple hidden" download="funkphonic.mp3">‚¨áÔ∏è Download MP3</a>
        <audio id="player" controls class="flex-1 min-w-[260px]"></audio>
      </div>
      <p class="text-xs text-gray-400 mt-2">No API keys live in your browser. All requests are proxied securely through your Worker.</p>
    </section>
  </main>

  <script>
    // ===== CONFIG (uses your Cloudflare Worker) =====
    const PROXY_BASE = 'https://funkphonic.funkulture1.workers.dev';
    const CLONE_URL = PROXY_BASE + '/clone';
    const TTS_URL   = PROXY_BASE + '/tts';

    // ===== Elements =====
    const $ = (id)=> document.getElementById(id);
    const msg = $('msg'), errBox = $('err');

    const scriptEl = $('script');
    const moodEl = $('mood');
    const speedEl = $('speed');
    const speedLabel = $('speedLabel');

    const voiceName = $('voice-name');
    const drop = $('drop');
    const fileInput = $('voice-file');
    const fileName = $('fileName');
    const uploadBtn = $('upload');
    const upSpin = $('up-spin');
    const voiceStatus = $('voice-status');

    const genBtn = $('generate');
    const genSpin = $('gen-spin');
    const player = $('player');
    const downloadA = $('download');

    // ===== UI helpers =====
    function showMsg(text, type='info', ms=3800){
      msg.className = 'msg ' + type;
      msg.textContent = text;
      msg.style.display = 'block';
      if(ms) setTimeout(()=> msg.style.display='none', ms);
    }
    function showErr(e){
      const t = (typeof e === 'string') ? e : (e?.message || JSON.stringify(e));
      errBox.style.display='block'; errBox.textContent = t;
    }
    function clearErr(){ errBox.style.display='none'; errBox.textContent=''; }
    function busy(btn, spinner, on=true){ if(btn) btn.disabled = on; if(spinner) spinner.style.visibility = on ? 'visible' : 'hidden'; }

    // ===== Local voice_id store =====
    const setVoiceId = (id)=> localStorage.setItem('eleven_voice_id', id || '');
    const getVoiceId = ()=> localStorage.getItem('eleven_voice_id') || '';
    function refreshVoiceStatus(){
      const id = getVoiceId();
      voiceStatus.textContent = id ? `Voice ready (id: ${id.slice(0,8)}‚Ä¶)` : 'No voice uploaded yet.';
    }
    refreshVoiceStatus();

    // ===== Speed label =====
    speedEl.addEventListener('input', ()=>{
      const v = Number(speedEl.value||1);
      speedLabel.textContent = v.toFixed(2) + '√ó';
      player.playbackRate = v;
    });

    // ===== Drag & Drop handling =====
    const openPicker = ()=> fileInput.click();
    drop.addEventListener('click', openPicker);
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('drag');
      if(e.dataTransfer.files && e.dataTransfer.files[0]){
        fileInput.files = e.dataTransfer.files;
        fileName.textContent = e.dataTransfer.files[0].name;
      }
    });
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files && fileInput.files[0];
      fileName.textContent = f ? f.name : 'No file selected.';
    });

    // ===== Upload & Clone (to /clone) =====
    uploadBtn.addEventListener('click', async ()=>{
      const name = (voiceName.value||'').trim();
      const file = fileInput.files && fileInput.files[0];
      if(!name){ showMsg('Name your voice.', 'error'); return; }
      if(!file){ showMsg('Choose or drop an audio file.', 'error'); return; }

      busy(uploadBtn, upSpin, true); clearErr();
      try{
        const fd = new FormData();
        fd.append('name', name);
        fd.append('file', file, file.name);

        const res = await fetch(CLONE_URL, { method:'POST', body: fd });
        const txt = await res.text();
        if(!res.ok) throw new Error(txt || `Clone failed (${res.status})`);

        let data = {}; try{ data = JSON.parse(txt); }catch{}
        const vid = (data.voice_id || data?.voice?.voice_id || '').toString();
        if(!vid) throw new Error('Clone succeeded but no voice_id returned.');
        setVoiceId(vid);
        refreshVoiceStatus();
        showMsg('‚úÖ Voice cloned and stored.', 'success');
      }catch(e){
        showMsg('Upload failed. See details below.', 'error', 7000);
        showErr(e);
      }finally{
        busy(uploadBtn, upSpin, false);
      }
    });

    // ===== Generate MP3 (to /tts) =====
    genBtn.addEventListener('click', async ()=>{
      const text = (scriptEl.value||'').trim();
      if(!text){ showMsg('Type your vocal script first.', 'error'); return; }

      busy(genBtn, genSpin, true); clearErr();
      downloadA.classList.add('hidden'); player.removeAttribute('src');

      try{
        const body = { text };
        const vid = getVoiceId(); if(vid) body.voice_id = vid;
        const mood = (moodEl.value||'').trim(); if(mood) body.mood = mood;

        const res = await fetch(TTS_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(t || `TTS failed (${res.status})`);
        }

        const buf = await res.arrayBuffer();
        const blob = new Blob([buf], { type:'audio/mpeg' });
        const url  = URL.createObjectURL(blob);

        player.src = url;
        try{ player.playbackRate = Number(speedEl.value||1); await player.play(); }catch{}
        downloadA.href = url;
        downloadA.classList.remove('hidden');
        showMsg('üéß MP3 ready ‚Äî download below.', 'success');
      }catch(e){
        showMsg('Generation error. See details below.', 'error', 7000);
        showErr(e);
      }finally{
        busy(genBtn, genSpin, false);
      }
    });

    // ===== Optional PWA SW (only if you have worker.js in this repo) =====
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> {
        navigator.serviceWorker.register('./worker.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
