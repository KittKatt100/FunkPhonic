<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FunkPhonic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7A1FA2" />
  <style>
    /* (same CSS as before for branding) */
    :root {
      --bg:#151515; --fg:#ffffff;
      --purple:#7A1FA2; --orange:#FF7227;
      --heli:#DF5086; --teal:#24B3A8;
    }
    body {
      background:var(--bg); color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card {
      width:100%; max-width:720px; background:#1a1a1a; border:1px solid var(--teal);
      border-radius:20px; box-shadow:0 0 24px rgba(122,31,162,.35);
      padding:28px; display:flex; flex-direction:column; gap:18px;
    }
    textarea {
      background:#242424; color:#fff; border:2px solid var(--purple); border-radius:12px;
      padding:14px; min-height:140px; resize:vertical; outline:none;
    }
    select, button {
      background:var(--purple); color:#fff; border:none; border-radius:12px; padding:12px 16px;
    }
    button {
      font-weight:700; box-shadow:0 0 10px rgba(122,31,162,.4);
      transition:.2s transform,.2s background;
    }
    button:hover { transform:translateY(-2px); }
    .btn-orange { background:var(--orange); }
    .btn-orange:hover { background:#e25f17; }
    .btn-purple { background:var(--purple); }
    .btn-purple:hover { background:#6b1593; }
    .btn-teal { background:var(--teal); }
    .btn-teal:hover { background:#1ea197; }
    .chip {
      background:#242424; border:1px solid #333; border-radius:999px;
      padding:6px 10px; font-size:12px; color:#aaa;
    }
    .spinner {
      border:4px solid rgba(255,255,255,.25); border-left-color:var(--teal);
      width:22px;height:22px;border-radius:50%;
      animation:spin 1s linear infinite; display:inline-block;
      vertical-align:middle; margin-left:8px; visibility:hidden;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .msg {
      display:none; padding:12px 14px; border-radius:12px; text-align:center;
      font-weight:600;
    }
    .msg.info{ background:#17324d; color:#cfe9ff; }
    .msg.error{ background:#4d1717; color:#ffd0d0; }
    .msg.success{ background:#0f3a33; color:#bff1ea; }
    .link-ghost {
      color:var(--teal); text-decoration:none; font-weight:700;
      display:none; text-align:center;
    }
    .row {
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
    }
    .row > * { flex:1 1 auto; }
    .row .tight { flex:0 0 auto; }
  </style>
</head>
<body>
  <main class="card">
    <header class="text-center">
      <h1 class="text-4xl font-extrabold text-[#DF5086]">FunkPhonic</h1>
      <p class="mt-1 text-sm text-gray-300">
        Type a script â†’ choose engine â†’ talk it out â†’ <span class="text-[#24B3A8]">download MP3 (ElevenLabs)</span>
      </p>
    </header>

    <section>
      <label class="block mb-2 text-sm text-gray-300">Describe the script</label>
      <textarea id="text-input" placeholder="e.g., Write a 15-second hype ad for FunkPhonic..."></textarea>
    </section>

    <section class="row">
      <div>
        <label class="block mb-2 text-sm text-gray-300">Voice Engine</label>
        <select id="engine-select" class="w-full">
          <option value="browser">Browser (device voices)</option>
          <option value="elevenlabs">ElevenLabs (API)</option>
        </select>
      </div>
      <div id="browser-voice-wrap">
        <label class="block mb-2 text-sm text-gray-300">Select Voice (Browser)</label>
        <select id="voice-select" class="w-full"></select>
      </div>
      <div class="tight">
        <button id="settings-btn" class="btn-teal">âš™ï¸ Settings</button>
      </div>
    </section>

    <section class="row">
      <button id="generate-btn" class="btn-orange">âœ¨ Generate Script <span id="gen-spinner" class="spinner"></span></button>
      <button id="speak-btn" class="btn-purple">ğŸ—£ï¸ Speak It</button>
      <button id="stop-btn" class="btn-purple">â›” Stop</button>
      <button id="voicegen-btn" class="btn-teal">ğŸ§ Generate Voice <span id="tts-spinner" class="spinner"></span></button>
      <a id="download-link" class="link-ghost" href="#" download="funkphonic-voice.mp3">â¬‡ï¸ Download Audio</a>
    </section>

    <div id="msg" class="msg info"></div>

    <div class="row">
      <div class="chip">Tip: â€œGenerate Scriptâ€ writes the script. â€œSpeak Itâ€ uses device voices. â€œGenerate Voiceâ€ uses ElevenLabs + download.</div>
    </div>
  </main>

  <script>
    // Elements setup
    const textInput = document.getElementById('text-input');
    const engineSelect = document.getElementById('engine-select');
    const voiceSelect = document.getElementById('voice-select');
    const browserVoiceWrap = document.getElementById('browser-voice-wrap');
    const generateBtn = document.getElementById('generate-btn');
    const speakBtn = document.getElementById('speak-btn');
    const stopBtn = document.getElementById('stop-btn');
    const voiceGenBtn = document.getElementById('voicegen-btn');
    const genSpinner = document.getElementById('gen-spinner');
    const ttsSpinner = document.getElementById('tts-spinner');
    const downloadLink = document.getElementById('download-link');
    const settingsBtn = document.getElementById('settings-btn');
    const msg = document.getElementById('msg');

    // TTS & audio
    const synth = window.speechSynthesis;
    const audioPlayer = new Audio();
    let voices = [], audioBlob = null;

    // Utility messaging
    function showMsg(text, type='info', timeout=4500){
      msg.className = 'msg ' + type;
      msg.textContent = text;
      msg.style.display = 'block';
      if (timeout) setTimeout(() => msg.style.display = 'none', timeout);
    }
    function setBusy(el, spinning=true){
      if (el === generateBtn) genSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el === voiceGenBtn) ttsSpinner.style.visibility = spinning ? 'visible' : 'hidden';
      if (el) el.disabled = spinning;
      speakBtn.disabled = spinning && el === voiceGenBtn;
      stopBtn.disabled = spinning && el === voiceGenBtn;
    }

    // Populate browser voices
    function populateVoices(){
      voices = synth.getVoices().filter(v => v && v.name && v.lang);
      voiceSelect.innerHTML = '';
      if (!voices.length) {
        const opt = document.createElement('option');
        opt.textContent = 'No voices found. Refresh browser.';
        voiceSelect.appendChild(opt);
        return;
      }
      voices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})${v.default ? ' â€¢ default' : ''}`;
        voiceSelect.appendChild(opt);
      });
      const pref = voices.find(v => v.name.includes('Google')) || voices[0];
      if (pref) voiceSelect.value = pref.name;
      showMsg(`ğŸ§ Loaded ${voices.length} device voices`, 'info', 2500);
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoices;
    window.addEventListener('load', populateVoices);

    // Demo script generation
    generateBtn.addEventListener('click', () => {
      const prompt = textInput.value.trim();
      if (!prompt) return showMsg('Type a prompt first.', 'error');
      setBusy(generateBtn, true);
      setTimeout(() => {
        textInput.value = `${prompt}\n\n[FunkPhonic draft]\nFast intro. One benefit per line. Bold CTA.`;
        setBusy(generateBtn, false);
        showMsg('âœ¨ Script ready.', 'success');
      }, 1000);
    });

    // Browser TTS
    function speakBrowser(text){
      if (!text) return showMsg('Nothing to speak.', 'error');
      if (synth.speaking) synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const sel = voices.find(v => v.name === voiceSelect.value);
      if (sel) utter.voice = sel;
      utter.onend = () => showMsg('âœ… Done speaking.', 'success');
      utter.onerror = e => showMsg('Speech error: ' + (e.error||''), 'error');
      synth.speak(utter);
      downloadLink.style.display = 'none';
    }

    speakBtn.addEventListener('click', () => {
      if (engineSelect.value === 'elevenlabs') {
        showMsg('Use â€œGenerate Voiceâ€ for downloadable audio.', 'info');
        return;
      }
      speakBrowser(textInput.value.trim());
    });

    stopBtn.addEventListener('click', () => {
      if (synth.speaking) synth.cancel();
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      showMsg('â›” Stopped', 'info');
    });

    // ElevenLabs settings
    function getEleven(){
      return {
        key: localStorage.getItem('eleven_api_key') || '',
        voice: localStorage.getItem('eleven_voice_id') || ''
      };
    }
    function setEleven(key, voice){
      localStorage.setItem('eleven_api_key', key || '');
      localStorage.setItem('eleven_voice_id', voice || '');
    }
    settingsBtn.addEventListener('click', () => {
      const cur = getEleven();
      const apiKey = prompt('ElevenLabs API Key (saved locally):', cur.key || '');
      if (apiKey === null) return;
      const voiceId = prompt('ElevenLabs Voice ID:', cur.voice || '');
      if (voiceId === null) return;
      setEleven(apiKey.trim(), voiceId.trim());
      showMsg('Saved ElevenLabs settings locally.', 'success');
    });

    // ElevenLabs TTS (download)
    async function ttsElevenLabs(text){
      const { key, voice } = getEleven();
      if (!key || !voice) return showMsg('Set ElevenLabs API + Voice ID.', 'error');
      setBusy(voiceGenBtn, true);
      downloadLink.style.display = 'none';
      try {
        const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'xi-api-key': key },
          body: JSON.stringify({ text, model_id:'eleven_monolingual_v1', voice_settings:{ stability:0.5, similarity_boost:0.75 } })
        });
        if (!res.ok) throw new Error('TTS failed: ' + res.status);
        const buf = await res.arrayBuffer();
        audioBlob = new Blob([buf], { type:'audio/mpeg' });
        const url = URL.createObjectURL(audioBlob);
        audioPlayer.src = url;
        audioPlayer.play();
        downloadLink.href = url;
        downloadLink.style.display = 'block';
        showMsg('ğŸ§ Voice readyâ€”download below.', 'success');
      } catch(e){
        console.error(e);
        showMsg('ElevenLabs errorâ€”check settings/credits.', 'error');
      } finally {
        setBusy(voiceGenBtn, false);
      }
    }
    voiceGenBtn.addEventListener('click', () => {
      const text = textInput.value.trim();
      if (!text) return showMsg('Type or generate your script first.', 'error');
      if (engineSelect.value === 'browser') {
        showMsg('Switch to ElevenLabs for downloads.', 'info');
        speakBrowser(text);
        return;
      }
      ttsElevenLabs(text);
    });

    engineSelect.addEventListener('change', () => {
      browserVoiceWrap.style.display = engineSelect.value === 'browser' ? 'block' : 'none';
      if (engineSelect.value !== 'browser') downloadLink.style.display = 'none';
    });
    browserVoiceWrap.style.display = 'block';
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW reg failed:', err));
      });
    }
  </script>
</body>
</html>
